<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil</title>
    <link rel="stylesheet" type="text/css" href="onsenui/css/onsenui.css" />
    <link rel="stylesheet" type="text/css" href="onsenui/css/onsen-css-components.min.css" />
    <script src="onsenui/js/onsenui.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <ons-icon size="30px" style="margin-left: 10px; margin-top: 10px;" icon="md-arrow-back" onclick="BackButton()">
    </ons-icon>
</head>

<style>
    * {
        box-sizing: border-box;
    }

    body {
        font: 16px Arial;
    }

    input[type=text] {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        border-radius: 10px;
        padding: 10px;
        font-size: 16px;
        background-color: #f1f1f1;
        width: 100%;
    }

    input[type=number] {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        border-radius: 10px;
        padding: 10px;
        font-size: 16px;
        background-color: #f1f1f1;
        width: 100%;
    }

    input[type=date] {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        border-radius: 10px;
        padding: 10px;
        font-size: 16px;
        background-color: #f1f1f1;
        width: 100%;
    }

    input[type=color] {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        border-radius: 10px;
        /*        padding: 1px;*/
        font-size: 16px;
        width: 50px;
        height: 40px;
        /*        margin: .4rem;*/
    }

    select {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        border-radius: 10px;
        /*        padding: 1px;*/
        font-size: 16px;
        width: 50px;
        height: 40px;
        /*        margin: .4rem;*/
    }

    p {
        font-family: Calibri;
        font-size: 18px;
    }
</style>

<body>

    <ons-page>
        <ons-toolbar>
            <div class="left">
                <ons-icon size="30px" style="margin-left: 10px" icon="md-arrow-back" onclick="BackButton()"></ons-icon>
            </div>
            <div class="center">Nutztier anlegen</div>
            <div class="right"></div>
        </ons-toolbar>
        <ons-card>
            <form>
                <p style="margin-top: 20px; margin-left: 10%; width:200px; font-weight: 500;">Nutztier Kennzeichnung</p>
                <svg id="SvgObj" width="480" height="280">
                    <clipPath id="cut-off-bottom">
                        <rect x="0" y="0" width="500" height="100" />
                    </clipPath>

                    <rect id="rect1" x="50" y="100" rx="20" ry="20" width="250" stroke="black" stroke-width="2"
                        height="150" style="fill:red" />
                    <circle id="circle1" cx="180" cy="100" r="70" clip-path="url(#cut-off-bottom)" stroke="black"
                        stroke-width="2" style="fill:red" />
                    <rect id="rect2" x="111" y="98" width="138" height="5" style="fill:red" />
                    <circle id="circle2" cx="180" cy="90" r="20" fill="white" stroke="black" stroke-width="2" />

                    <text id="Svgtext1" onclick="showInfo('countryCode')" fill="black" font-size="30"
                        font-family="Verdana" x="90" y="140">AT</text>
                    <text id="Svgtext2" onclick="showInfo('stateCode')" fill="black" font-size="30"
                        font-family="Verdana" x="240" y="140">3</text>
                    <text id="Svgtext3" onclick="showInfo('LFBISCode')" fill="black" font-size="30"
                        font-family="Verdana" x="120" y="230">4321056</text>
                    <foreignObject id="CodeDigit0Obj" width="40" height="50" x="105" y="155">
                        <input id="CodeDigit0" class="input-real" type="number" placeholder="X" maxlength="0"
                            style="text-align: center;border-color : black; border-width: medium;"
                            onfocus="this.value=''" />
                    </foreignObject>
                    <foreignObject id="CodeDigit1Obj" width="40" height="50" x="105" y="155">
                        <input id="CodeDigit1" class="input-real" type="number" placeholder="X" maxlength="1"
                            style="text-align: center;border-color : black; border-width: medium;"
                            onfocus="this.value=''" />
                    </foreignObject>
                    <foreignObject id="CodeDigit2Obj" width="40" height="50" x="105" y="155">
                        <input id="CodeDigit2" class="input-real" type="number" placeholder="X" maxlength="1"
                            style="text-align: center;border-color : black; border-width: medium;"
                            onfocus="this.value=''" />
                    </foreignObject>
                    <foreignObject id="CodeDigit3Obj" width="40" height="50" x="105" y="155">
                        <input id="CodeDigit3" class="input-real" type="number" placeholder="X" maxlength="1"
                            style="text-align: center;border-color : black; border-width: medium;"
                            onfocus="this.value=''" />
                    </foreignObject>
                </svg>
                <hr>
                <ons-row id="RowColor">
                    <ons-col id="Col1Color" style="margin-left: 10%; margin-top: 30px">Farbe</ons-col>
                    <ons-col id="Col2Color">
                        <ons-button id="Color"
                            style="margin-top: 20px; padding: 19px; border-radius: 10px; background-color: red; border-color : black; border-width: medium; width: 140px"
                            onclick="showTemplateDialog('color', 'color.html')"></ons-button>
                    </ons-col>
                </ons-row>
                <ons-row>
                    <ons-col style="margin-left: 10%; margin-top: 30px">Standort</ons-col>
                    <ons-col style="margin-left: 1%; margin-top: 20px">
                        <!--                        <input id="Place" type="text" placeholder="Nutztier Name" style="text-align: right; width:140px; margin-top: 20px" value="Stall">-->
                        <select id="ChooseSelPlace" style="text-align: right; width:140px;">
                            <option value="Dekzentrum">Dekzentrum</option>
                            <option value="Wartestall">Wartestall</option>
                            <option value="Abferkelbox">Abferkelbox</option>
                            <option value="Quarantäne Stall">Quarantäne Stall</option>
                            <option value="Futterventil">Futterventil</option>
                        </select>
                    </ons-col>
                </ons-row>
                <ons-row>
                    <ons-col style="margin-left: 10%; margin-top: 30px">Geboren am</ons-col>
                    <ons-col>
                        <input id="BornOn" type="date" value="tt.mm.jjjj "
                            style="width:140px; margin-top: 20px"><br><br>
                    </ons-col>
                </ons-row>
                <section style="margin-left: 10%; margin-right: 10%; margin-top: 10%;  margin-bottom: 10%">
                    <ons-button style=" border-radius: 10px;background-color: #2BA1E1" modifier="large"
                        onclick="checkInputs()"> Erledigt
                        <ons-icon size="15px" style="margin-left: 5px" icon="fa-check"></ons-icon>
                    </ons-button>
                </section>
            </form>
        </ons-card>
    </ons-page>

    <template id="color.html">
        <ons-dialog id="color" cancelable>
            <div style="text-align: center; padding: 5px;">
                <p>
                    <b>
                        Farbe auswählen
                    </b>
                </p>
            </div>
            <ons-list>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-1', 'yellow')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-1"></ons-checkbox>
                    </label>
                    <label for="check-1" class="center">
                        <ons-icon style="margin-right: 10px; color: yellow;" icon="fa-square-full"></ons-icon>
                        Gelb
                    </label>
                </ons-list-item>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-2', 'red')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-2"></ons-checkbox>
                    </label>
                    <label for="check-1" class="center">
                        <ons-icon style="margin-right: 10px; color: red;" icon="fa-square-full"></ons-icon>
                        Rot
                    </label>
                </ons-list-item>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-3', 'blue')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-3"></ons-checkbox>
                    </label>
                    <label for="check-2" class="center">
                        <ons-icon style="margin-right: 10px; color: blue;" icon="fa-square-full"></ons-icon>
                        Blau
                    </label>
                </ons-list-item>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-4', 'green')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-4"></ons-checkbox>
                    </label>
                    <label for="check-2" class="center">
                        <ons-icon style="margin-right: 10px; color: green;" icon="fa-square-full"></ons-icon>
                        Grün
                    </label>
                </ons-list-item>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-5', 'orange')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-5"></ons-checkbox>
                    </label>
                    <label for="check-2" class="center">
                        <ons-icon style="margin-right: 10px; color: orange;" icon="fa-square-full"></ons-icon>
                        Orange
                    </label>
                </ons-list-item>
                <ons-list-item onchange="hideDialogColor('color', 'checkColor-6', 'white')" tappable>
                    <label class="left">
                        <ons-checkbox input-id="checkColor-6"></ons-checkbox>
                    </label>
                    <label for="check-2" class="center">
                        <ons-icon style="margin-right: 10px;  color: whitesmoke;" icon="fa-square"></ons-icon>
                        Weiß
                    </label>
                </ons-list-item>
            </ons-list>
        </ons-dialog>
    </template>

    <script type="text/javascript ">
        db = window.openDatabase("Database", "1.0", "Nutztier DB", 20 * 1024 * 1024); //create 20MB Database
        var place = "";
        var color = "";
        var number = "";
        var born = "";
        var createdOn = "";
        var timestamp = "";
        var crc = "";
        var code = "";
        var token = "";
        var uuid = "";
        var switchState = "";
        var ipAdress = "";

        $(document).ready(function () {
            switchState = localStorage.getItem("settings_request")
            ipAdress = localStorage.getItem("settings_ipAdress")
            //calc window size and adapte SVG Object
            var w = window.innerWidth;
            var h = window.innerHeight;
            console.log(w)
            console.log(((w - 250) / 2))
            console.log(h)
            var OffsestWidthX = (w - 250 - 50) / 2
            //set Object width depending on Display width
            document.getElementById("SvgObj").setAttribute("width", w - 30);
            document.getElementById("rect1").setAttribute("x", OffsestWidthX);
            document.getElementById("circle1").setAttribute("cx", OffsestWidthX + 130);
            document.getElementById("circle2").setAttribute("cx", OffsestWidthX + 130);
            document.getElementById("rect2").setAttribute("x", OffsestWidthX + 61);
            document.getElementById("CodeDigit0Obj").setAttribute("x", OffsestWidthX + 40);
            document.getElementById("CodeDigit1Obj").setAttribute("x", OffsestWidthX + 85);
            document.getElementById("CodeDigit2Obj").setAttribute("x", OffsestWidthX + 130);
            document.getElementById("CodeDigit3Obj").setAttribute("x", OffsestWidthX + 175);
            document.getElementById("Svgtext1").setAttribute("x", OffsestWidthX + 40);
            document.getElementById("Svgtext2").setAttribute("x", OffsestWidthX + 190);
            document.getElementById("Svgtext3").setAttribute("x", OffsestWidthX + 70);
            if (localStorage.getItem("ChooseSelPlaceStorage") !== null) {
                document.getElementById("ChooseSelPlace").value = localStorage.getItem("ChooseSelPlaceStorage");
            }
            if (localStorage.getItem("MarkColor") !== null) {
                document.getElementById("Color").style.backgroundColor = localStorage.getItem("MarkColor");
                document.getElementById("rect1").style.fill = localStorage.getItem("MarkColor");
                document.getElementById("rect2").style.fill = localStorage.getItem("MarkColor");
                document.getElementById("circle1").style.fill = localStorage.getItem("MarkColor");
            }
            let today = new Date().toISOString().substr(0, 10);
            document.querySelector("#BornOn").value = today;
            //create table in database
            db.transaction(function (tx) {
                            //    tx.executeSql('DROP TABLE IF EXISTS Nutztiere');
                tx.executeSql(
                    'CREATE TABLE IF NOT EXISTS Nutztiere (Timestamp, Born, Color, Number, Place, tagged, DBSyncServer)'
                    );
            }, function (error) {
                alert('Error: ' + error.message + ' code: ' + error.code);
            }, function () {});
            db.transaction(function (transaction) {
                transaction.executeSql('SELECT * FROM user', [], function (tx, results) {
                    //get buisness code for requests
                    code = results.rows.item(0).code;
                    //get user token
                    token = results.rows.item(0).token;
                    //get current mobile uuid
                    uuid = results.rows.item(0).uuid;
                }, null);
            });
            //select between inputs
            $("#CodeDigit0").keyup(function () {
                if (document.getElementById("CodeDigit0").value != '') {
                    if (document.getElementById("CodeDigit1").value == '') {
                        document.getElementById("CodeDigit1").focus();
                    } else {
                        document.getElementById("CodeDigit0").blur();
                    }
                }
            });
            $("#CodeDigit1").keyup(function () {
                if (document.getElementById("CodeDigit1").value != '') {
                    if (document.getElementById("CodeDigit2").value == '') {
                        document.getElementById("CodeDigit2").focus();
                    } else {
                        document.getElementById("CodeDigit1").blur();
                    }
                }
            });
            $("#CodeDigit2").keyup(function () {
                if (document.getElementById("CodeDigit2").value != '') {
                    if (document.getElementById("CodeDigit3").value == '') {
                        document.getElementById("CodeDigit3").focus();
                    } else {
                        document.getElementById("CodeDigit2").blur();
                    }
                }
            });
            $("#CodeDigit3").keyup(function () {
                if (document.getElementById("CodeDigit3").value != '') {
                    document.getElementById("CodeDigit3").blur();
                }
            });
        });

        var showTemplateDialog = function (my_dialog, my_dialog_html) {

            var dialog = document.getElementById(my_dialog);

            if (dialog) {
                dialog.show();
            } else {
                ons.createElement(my_dialog_html, {
                        append: true
                    })
                    .then(function (dialog) {
                        dialog.show();
                    });
            }
        };

        var showInfo = function (code) {
            if (code == "countryCode") {
                ons.notification.alert({
                    message: 'Ländercode: AT steht für Österrreich',
                    title: 'Ohrmarken Info',
                });
            } else if (code == "stateCode") {
                ons.notification.alert({
                    message: 'Bundeslandcode: 3 steht für Oberösterreich',
                    title: 'Ohrmarken Info',
                });
            } else if (code == "LFBISCode") {
                ons.notification.alert({
                    message: 'LFBIS Nummer deines Betriebs',
                    title: 'Ohrmarken Info',
                });
            }
        };

        //select color
        var hideDialogColor = function (id, checkbox, color) {
            document.getElementById("checkColor-1").checked = false;
            document.getElementById("checkColor-2").checked = false;
            document.getElementById("checkColor-3").checked = false;
            document.getElementById("checkColor-4").checked = false;
            document.getElementById("checkColor-5").checked = false;
            document.getElementById("checkColor-6").checked = false;
            document.getElementById(checkbox).checked = true;
            document.getElementById("Color").style.backgroundColor = color;
            document.getElementById("rect1").style.fill = color;
            document.getElementById("rect2").style.fill = color;
            document.getElementById("circle1").style.fill = color;
            localStorage.setItem("MarkColor", color);
            document.getElementById(id).hide();
        };

        function checkInputs() {
            var CodeDigit0 = document.getElementById("CodeDigit0").value;
            var CodeDigit1 = document.getElementById("CodeDigit1").value;
            var CodeDigit2 = document.getElementById("CodeDigit2").value;
            var CodeDigit3 = document.getElementById("CodeDigit3").value;
            number = CodeDigit0 + CodeDigit1 + CodeDigit2 + CodeDigit3
            place = document.getElementById("ChooseSelPlace").value;
            localStorage.setItem("ChooseSelPlaceStorage", place);
            color = document.getElementById("Color").style.backgroundColor;
            born = document.getElementById("BornOn").value;
            let today = new Date().toISOString().substr(0, 10);
            //set timestamp to each database entry in millisec
            timestamp = Date.now();
            //calculate crc over data
            crc = CRC32(place + color + number + born + createdOn + timestamp)
            console.log(crc)
            if (number.length == 4) {
                if (switchState == 'true') {
                    requestData()
                } else {
                    write2DB()
                }
            } else {
                ons.notification.alert({
                    message: 'Die Nummer muss aus 4 Ziffern bestehen',
                    title: 'Ohrmarkennummer Fehler',
                });
            }

        }

        function requestData() {
            var endpoint = ipAdress + "database/livestock/" + code
            alert(endpoint)
            $.ajax({
                url: endpoint,
                contentType: "application/json",
                type: "POST",
                data: JSON.stringify({
                    "action": "commit",
                    "crc": crc,
                    "number": number,
                    "color": color,
                    "place": place,
                    "born": born,
                    "timestamp": timestamp,
                    "user": token,
                    "device_uuid": uuid
                }),
                success: function (data) {
                    alert(data)
                    write2DB()
                }
            });
        }

        function write2DB() {
            db.transaction(function (transaction) {
                var executeQuery =
                    "INSERT INTO Nutztiere (Timestamp, Born, Color, Number, Place , tagged, DBSyncServer) VALUES (?,?,?,?,?,?,?)";
                transaction.executeSql(executeQuery, [timestamp, born, color, number, place, "false", "true"],
                    function (tx, result) {
                        window.location = "livestock.html";
                    },
                    function (error) {
                        alert('Error: ' + error.message + ' code: ' + error.code);
                    });
            });
        }

        function readDB() {
            db.transaction(function (transaction) {
                transaction.executeSql('SELECT * FROM Nutztiere', [], function (tx, results) {
                    //                    alert(results.rows)
                    console.log(results.rows)
                    //                    var len = results.rows.length,
                    //                        i;
                    //                    $("#rowCount").append(len);
                    //                    for (i = 0; i < len; i++) {
                    //                        $("#TableData").append("<tr><td>" + results.rows.item(i).id + "</td><td>" + results.rows.item(i).title + "</td><td>" + results.rows.item(i).desc + "</td></tr>");
                    //                    }

                }, null);
            });
        }

        function deleteDB() {
            db.transaction(function (transaction) {
                var executeQuery = "DROP TABLE IF EXISTS Nutztiere";
                transaction.executeSql(executeQuery, [],
                    function (tx, result) {
                        localStorage.clear();
                        alert('Table deleted successfully.');
                    },
                    function (error) {
                        alert('Error occurred while droping the table.');
                    }
                );
            });
        }

        function BackButton() {
            window.location = "livestock.html ";

        }
    </script>
    <script type="text/javascript" src="js/crc32.js"></script>
</body>

</html>